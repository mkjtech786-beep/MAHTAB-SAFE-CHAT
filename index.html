<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MAHTAB PRIVATE CHAT 2.0-</title>

<link href="https://fonts.googleapis.com/css2?family=Helvetica+Neue:wght@400;500;600&display=swap" rel="stylesheet">

<style>
:root {
  /*--- WHATSAPP DARK THEME COLORS ---*/
  --bg-color: #0b141a;       /* WA Dark Background */
  --chat-bg: #0b141a;        /* Chat Area Background */
  
  /* Bubbles */
  --user-bubble: #005c4b;    /* WA Dark Green Bubble */
  --admin-bubble: #202c33;   /* WA Dark Grey Bubble */
  
  --header-bg: #202c33;
  --input-bg: #202c33;
  
  --text-primary: #e9edef;
  --text-secondary: #8696a0;
  --primary-accent: #00a884; /* WA Green Accent */
}

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  background: var(--bg-color);
  color: var(--text-primary);
  background-image: url('https://i.pinimg.com/736x/8c/98/99/8c98994518b575bfd8c949e91d20548b.jpg'); /* Optional WA Doodle BG */
  background-blend-mode: overlay;
  background-size: cover;
}

.app {
  display: flex;
  flex-direction: column;
  height: 100%;
  height: calc(var(--vh, 1vh) * 100);
}

/* --- WHATSAPP HEADER --- */
.header {
  padding: 10px 15px;
  background: var(--header-bg);
  display: flex;
  align-items: center;
  gap: 15px;
  z-index: 10;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

/* Avatar Circle */
.header-avatar {
  width: 40px;
  height: 40px;
  background: #6b7c85;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 20px;
}

.header-info {
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.header-name {
  font-weight: 600;
  font-size: 16px;
  color: var(--text-primary);
}

.header-status {
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 2px;
}
.header-status.online {
  color: #25D366; /* Green for Online */
  font-weight: 500;
}

/* --- MESSAGES AREA --- */
.msgs {
  flex: 1;
  padding: 10px 15px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

/* --- MESSAGE BUBBLES (WA STYLE) --- */
.msg {
  padding: 6px 7px 8px 9px;
  border-radius: 8px;
  margin-bottom: 4px;
  max-width: 75%;
  font-size: 14.2px;
  line-height: 19px;
  position: relative;
  word-wrap: break-word;
  box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
  display: flex;
  flex-direction: column;
}

/* USER STYLE (Green - Right) */
.msg.user {
  background: var(--user-bubble);
  color: var(--text-primary);
  align-self: flex-end;
  border-top-right-radius: 0; /* Corner effect */
}

/* ADMIN STYLE (Grey - Left) */
.msg.admin {
  background: var(--admin-bubble);
  color: var(--text-primary);
  align-self: flex-start;
  border-top-left-radius: 0; /* Corner effect */
}

/* --- TYPING INDICATOR --- */
.typing-container {
    padding: 5px 20px;
    align-self: flex-start;
    font-size: 12px;
    color: var(--primary-accent);
    font-style: italic;
}
.hidden { display: none !important; }

/* --- INPUT AREA --- */
.input-area {
  background: var(--input-bg);
  padding: 5px 10px;
  display: flex;
  align-items: center;
  min-height: 60px;
}

.input-controls {
  display: flex;
  align-items: center;
  width: 100%;
  gap: 8px;
}

.icon-btn {
  background: transparent;
  border: none;
  color: var(--text-secondary);
  font-size: 24px;
  cursor: pointer;
  padding: 5px;
}

.input-wrapper {
  flex: 1;
  background: #2a3942;
  border-radius: 20px;
  padding: 9px 12px;
  display: flex;
  align-items: center;
}

.input-wrapper input {
  width: 100%;
  background: transparent;
  border: none;
  outline: none;
  color: var(--text-primary);
  font-size: 15px;
}

.mic-btn {
  background: #00a884;
  width: 45px;
  height: 45px;
  border-radius: 50%;
  border: none;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  cursor: pointer;
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  transition: 0.2s;
}
.mic-btn.recording {
    background: #ff3b30;
    animation: pulse 1s infinite;
}
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

/* Audio Player */
.audio-msg {
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 200px;
  padding-bottom: 5px;
}
.audio-msg button {
  background: transparent;
  border: none;
  color: var(--text-secondary);
  font-size: 24px;
  cursor: pointer;
}
.audio-track {
  flex: 1;
  height: 3px;
  background: rgba(255,255,255,0.2);
  position: relative;
}
.audio-progress {
  height: 100%;
  background: #fff;
  width: 0%;
}

/* Info & Image */
.msg-content {
    padding-right: 0px; 
}
.msg-meta {
  display: flex;
  justify-content: flex-end;
  align-items: flex-end;
  gap: 3px;
  margin-top: -5px; 
  /* Float time to bottom right */
  float: right;
  padding-left: 10px;
  padding-top: 4px;
}

.time-text {
  font-size: 11px;
  color: rgba(255,255,255,0.6);
}

.tick-icon {
    font-size: 11px; /* Ticks size */
    line-height: 1;
}

.msg img {
  max-width: 100%;
  border-radius: 8px;
  margin-bottom: 5px;
  display: block;
}

/* Scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
</style>
</head>

<body>
<div class="app">
  <div class="header">
    <div class="header-avatar">M</div> <div class="header-info">
      <div class="header-name">MAHTAB KHAN JAMALI</div>
      <div class="header-status" id="adminStatusText">Loading...</div>
    </div>
  </div>

  <div class="msgs" id="msgs"></div>

  <div class="typing-container hidden" id="typingContainer">
      Admin is typing...
  </div>

  <div class="input-area">
    <div class="input-controls">
        <button class="icon-btn" onclick="sendImage()">+</button>
        <input type="file" id="imageInput" accept="image/*" style="display:none" />

        <div class="input-wrapper">
            <input id="text" placeholder="Message" autocomplete="off" />
        </div>

        <button class="mic-btn" id="mainActionBtn" onclick="handleAction()">ðŸŽ¤</button>
    </div>
  </div>
</div>

<script type="module">
// Mobile Height Fix
function setVH(){
  document.documentElement.style.setProperty('--vh', window.innerHeight * 0.01 + 'px');
}
setVH();
window.addEventListener('resize', setVH);

// Firebase Imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onValue, update, get, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAqfguS1ucAtklcl06eB1JIWQr46XMpe7g",
  authDomain: "safe-chat-c0b9c.firebaseapp.com",
  databaseURL: "https://safe-chat-c0b9c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "safe-chat-c0b9c",
  storageBucket: "safe-chat-c0b9c.firebasedatabase.app",
  messagingSenderId: "119640275300",
  appId: "1:119640275300:web:20ae984f4af1ffe6a62271"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// User ID Setup
let userId = localStorage.getItem("username");
if(!userId){
  userId = prompt("Enter your username:")?.trim() || "guest_"+Date.now();
  localStorage.setItem("username", userId);
}

// Sounds
const sendSound = new Audio("https://www.soundjay.com/buttons/sounds/button-16.mp3");
const receiveSound = new Audio("https://www.soundjay.com/buttons/sounds/button-09.mp3");

let msgsBox;
const textInput = document.getElementById("text");
const actionBtn = document.getElementById("mainActionBtn");

// --- 12 HOUR TIME FORMATTER ---
function formatTime(timestamp) {
    if(!timestamp) return "";
    const date = new Date(timestamp);
    let hours = date.getHours();
    const minutes = date.getMinutes().toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12 || 12;
    return `${hours}:${minutes} ${ampm}`;
}

// Toggle Mic/Send Icon
textInput.addEventListener('input', () => {
    if(textInput.value.trim().length > 0){
        actionBtn.innerHTML = "âž¤"; 
        actionBtn.style.background = "#00a884";
    } else {
        actionBtn.innerHTML = "ðŸŽ¤"; 
    }
});

// --- USER ONLINE STATUS LOGIC ---
const myStatusRef = ref(db, 'status/' + userId);
update(myStatusRef, { state: 'online', last_seen: serverTimestamp() });
onDisconnect(myStatusRef).set({ state: 'offline', last_seen: serverTimestamp() });

// --- ADMIN LAST SEEN LOGIC ---
function listenAdminStatus(){
    const statusText = document.getElementById("adminStatusText");
    onValue(ref(db, "status/admin"), (snap) => {
        if(snap.exists()){
            const data = snap.val();
            if(data.state === 'online'){
                statusText.innerText = "Online";
                statusText.classList.add("online");
            } else {
                statusText.classList.remove("online");
                const timeStr = formatTime(data.last_seen);
                statusText.innerText = `last seen today at ${timeStr}`;
            }
        } else {
            statusText.innerText = "Offline";
        }
    });
}

function updateLastActive(){
  update(ref(db,"chats/"+userId),{ lastActive: Date.now() });
}

function loadMessages(){
  onValue(ref(db,"chats/"+userId + "/messages"), snap => {
    msgsBox.innerHTML="";
    if(snap.exists()){
        snap.forEach(m => {
            const v = m.val();
            if(!v?.text && !v?.voice && !v?.image) return;

            const d = document.createElement("div");
            d.className = "msg " + (v.from==="admin"?"admin":"user");

            const content = document.createElement("div");
            content.className = "msg-content";

            if(v.image){
                const img = document.createElement("img");
                img.src = v.image;
                img.onclick = () => window.open(v.image,"_blank");
                content.appendChild(img);
            }
            
            if(v.text) {
                const txt = document.createElement("span");
                txt.textContent = v.text;
                content.appendChild(txt);
            }

            if(v.voice){
                const audioWrapper = document.createElement("div");
                audioWrapper.className = "audio-msg";
                const audio = new Audio(v.voice);
                const playBtn = document.createElement("button");
                playBtn.textContent = "â–¶";
                
                const track = document.createElement("div");
                track.className = "audio-track";
                const prog = document.createElement("div");
                prog.className = "audio-progress";
                track.appendChild(prog);

                playBtn.onclick = () => {
                    audio.paused ? (audio.play(), playBtn.textContent="â¸") : (audio.pause(), playBtn.textContent="â–¶");
                };
                audio.ontimeupdate = () => {
                    prog.style.width = (audio.currentTime/audio.duration)*100 + "%";
                };
                audio.onended = () => { playBtn.textContent="â–¶"; prog.style.width="0%"; };
                audioWrapper.append(playBtn, track);
                content.appendChild(audioWrapper);
            }

            d.appendChild(content);

            const meta = document.createElement("div");
            meta.className = "msg-meta";
            
            if(v.time){
                meta.innerHTML += `<span class="time-text">${formatTime(v.time)}</span>`;
            }

            if(v.from === "user"){
                const tickColor = v.status === "seen" ? "#53bdeb" : "#8696a0";
                meta.innerHTML += `<span class="tick-icon" style="color:${tickColor}; margin-left:3px;">âœ“âœ“</span>`;
            }
            d.appendChild(meta);
            msgsBox.appendChild(d);
        });
    }
    scrollToBottom();
  });
}

function listenForTyping() {
    onValue(ref(db, "chats/" + userId + "/typing_admin"), (snap) => {
        const typingContainer = document.getElementById("typingContainer");
        if (snap.exists() && snap.val() === true) {
            typingContainer.classList.remove("hidden");
        } else {
            typingContainer.classList.add("hidden");
        }
    });
}

function scrollToBottom() { msgsBox.scrollTop = msgsBox.scrollHeight; }

window.handleAction = () => {
    const textVal = textInput.value.trim();
    if(textVal.length > 0) sendMsg(); else toggleMic();
}

window.sendMsg = async () => {
  const input = document.getElementById("text");
  if(!input.value.trim()) return;
  const snap = await get(ref(db,"chats/"+userId+"/blocked"));
  if(snap.exists() && snap.val()===true) return alert("You are blocked âŒ");

  push(ref(db,"chats/"+userId + "/messages"),{
    from:"user", text:input.value, time:Date.now(), status:"sent"
  });
  sendSound.play().catch(()=>{});
  input.value="";
  actionBtn.innerHTML = "ðŸŽ¤";
  updateLastActive();
};

window.sendImage = () => {
  const imageInput = document.getElementById("imageInput");
  imageInput.click();
  imageInput.onchange = async () => {
    const file = imageInput.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onloadend = () => {
      push(ref(db, "chats/" + userId + "/messages"), {
        from: "user", image: reader.result, time: Date.now(), status: "sent"
      });
      sendSound.play().catch(() => {});
    };
    imageInput.value = "";
  };
};

let mediaRecorder, audioChunks = [];
let isRecording = false;

function toggleMic(){ if(!isRecording) startRecording(); else stopRecording(); }

async function startRecording(){
    try {
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        actionBtn.classList.add("recording");
        isRecording = true;
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
            actionBtn.classList.remove("recording");
            isRecording = false;
            const blob = new Blob(audioChunks, {type:"audio/webm"});
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                push(ref(db,"chats/"+userId + "/messages"),{ 
                    from:"user", voice:reader.result, time:Date.now(), status:"sent" 
                });
                sendSound.play().catch(()=>{});
            }
            stream.getTracks().forEach(track => track.stop());
        };
        mediaRecorder.start();
    } catch(e) { alert("Microphone permission denied."); }
}
function stopRecording(){ if(mediaRecorder) mediaRecorder.stop(); }

window.onload = () => {
  msgsBox = document.getElementById("msgs");
  updateLastActive();
  update(ref(db,"chats/"+userId), { started: Date.now() });
  setInterval(updateLastActive, 30000);
  loadMessages();
  listenForTyping();
  listenAdminStatus();
  document.getElementById("text").addEventListener("keypress", (e) => { if (e.key === "Enter") sendMsg(); });
};
</script>
</body>
</html>
