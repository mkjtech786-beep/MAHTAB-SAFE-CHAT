<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safe Chat - User</title>
    <style>
        :root {
            --primary-color: #008069;
            --bg-color: #e5ddd5;
            --chat-bg: #efe7dd;
            --my-msg-bg: #dcf8c6;
            --admin-msg-bg: #ffffff;
            --text-primary: #303030;
            --online-green: #25D366;
            --offline-red: #ea0038;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-color); height: 100vh; display: flex; justify-content: center; align-items: center; }

        /* Login Modal */
        #login-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .login-box {
            background: white; padding: 30px; border-radius: 10px; text-align: center; width: 300px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .login-box input {
            width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ccc; border-radius: 5px; outline: none;
        }
        .btn {
            background: var(--primary-color); color: white; border: none; padding: 10px 20px;
            border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px;
        }

        /* Main Chat Container */
        .chat-container {
            width: 100%; max-width: 450px; height: 100%; background: var(--chat-bg);
            display: flex; flex-direction: column; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        @media(min-width: 480px) { .chat-container { height: 90vh; border-radius: 10px; } }

        /* Header */
        .chat-header {
            background: var(--primary-color); color: white; padding: 15px; display: flex;
            align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .status-dot { height: 10px; width: 10px; background: var(--offline-red); border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-dot.online { background: var(--online-green); }
        .connection-status { font-size: 12px; opacity: 0.8; }

        /* Messages Area */
        .messages-area {
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay;
        }

        .message {
            max-width: 75%; padding: 8px 12px; border-radius: 8px; position: relative; font-size: 14.5px;
            word-wrap: break-word; box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .msg-left { align-self: flex-start; background: var(--admin-msg-bg); border-top-left-radius: 0; }
        .msg-right { align-self: flex-end; background: var(--my-msg-bg); border-top-right-radius: 0; }
        
        .msg-meta { display: flex; justify-content: flex-end; align-items: center; gap: 3px; font-size: 10px; color: #555; margin-top: 4px; }
        .msg-img { max-width: 100%; border-radius: 5px; margin-bottom: 5px; cursor: pointer; }
        .msg-audio { width: 200px; height: 35px; }

        /* Input Area */
        .input-area {
            background: #f0f0f0; padding: 10px; display: flex; align-items: center; gap: 10px;
        }
        .input-area input {
            flex: 1; padding: 10px; border: none; border-radius: 20px; outline: none;
        }
        .icon-btn {
            background: none; border: none; font-size: 20px; cursor: pointer; color: #555; transition: 0.2s;
        }
        .icon-btn:hover { color: var(--primary-color); }
        
        /* Recording UI */
        #recording-indicator {
            color: red; font-weight: bold; display: none; margin-right: 10px; font-size: 12px; animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Image Preview Modal */
        #image-preview-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center;
        }
        .preview-content { background: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 90%; }
        .preview-content img { max-width: 100%; max-height: 60vh; display: block; margin: 0 auto 15px auto; }
        .preview-actions { display: flex; gap: 10px; justify-content: center; }

        /* Hidden Inputs */
        #file-input { display: none; }
    </style>
</head>
<body>

    <!-- Login Modal -->
    <div id="login-modal">
        <div class="login-box">
            <h3>Welcome to Safe Chat</h3>
            <p>Enter your name to start</p>
            <input type="text" id="username-input" placeholder="Type your name..." maxlength="20">
            <button class="btn" onclick="login()">Start Chat</button>
        </div>
    </div>

    <!-- Main Chat -->
    <div class="chat-container" id="chat-container" style="display: none;">
        <header class="chat-header">
            <div>
                <h3>Admin Support</h3>
                <div class="connection-status">
                    <span id="status-dot" class="status-dot"></span>
                    <span id="admin-status-text">Connecting...</span>
                </div>
            </div>
            <div id="typing-indicator" style="font-size: 12px; font-style: italic; display: none;">Admin typing...</div>
        </header>

        <div class="messages-area" id="messages-area">
            <!-- Messages will load here -->
        </div>

        <div class="input-area">
            <button class="icon-btn" onclick="document.getElementById('file-input').click()">ðŸ“·</button>
            <input type="file" id="file-input" accept="image/*" onchange="handleImageSelect(event)">
            
            <input type="text" id="msg-input" placeholder="Type a message..." onkeypress="handleTyping(event)">
            
            <button class="icon-btn" id="mic-btn" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()">ðŸŽ¤</button>
            <span id="recording-indicator">Recording...</span>
            <button class="icon-btn" onclick="sendMessage('text')">âž¤</button>
        </div>
    </div>

    <!-- Image Preview -->
    <div id="image-preview-modal">
        <div class="preview-content">
            <h3>Send Image?</h3>
            <img id="preview-img" src="">
            <div class="preview-actions">
                <button class="btn" style="background: #ccc; color: #333;" onclick="closePreview()">Cancel</button>
                <button class="btn" onclick="sendImage()">Send</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, get, set, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqfguS1ucAtklcl06eB1JIWQr46XMpe7g",
            authDomain: "safe-chat-c0b9c.firebaseapp.com",
            databaseURL: "https://safe-chat-c0b9c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "safe-chat-c0b9c",
            storageBucket: "safe-chat-c0b9c.firebasedatabase.app",
            messagingSenderId: "119640275300",
            appId: "1:119640275300:web:20ae984f4af1ffe6a62271"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- State Management ---
        let currentUser = null;
        let userId = localStorage.getItem('chatUserId');
        let isRecording = false;
        let mediaRecorder;
        let audioChunks = [];
        let selectedImageBase64 = null;

        // --- DOM Elements ---
        const loginModal = document.getElementById('login-modal');
        const chatContainer = document.getElementById('chat-container');
        const msgInput = document.getElementById('msg-input');
        const msgsArea = document.getElementById('messages-area');
        const adminStatusText = document.getElementById('admin-status-text');
        const statusDot = document.getElementById('status-dot');
        const typingIndicator = document.getElementById('typing-indicator');

        // --- Initialization ---
        window.addEventListener('load', () => {
            if (userId) {
                // Auto Login
                getUserDataAndLogin(userId);
            } else {
                // Show Login
                loginModal.style.display = 'flex';
            }

            // Internet Connection Status
            const connectedRef = ref(db, ".info/connected");
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    if(currentUser) setUserOnline(true);
                } else {
                    adminStatusText.innerText = "Reconnecting...";
                    statusDot.className = "status-dot";
                }
            });
        });

        // --- Login Logic ---
        window.login = async () => {
            const name = document.getElementById('username-input').value.trim();
            if (!name) return alert("Please enter name");

            // Generate ID
            const newUserRef = push(ref(db, 'users'));
            userId = newUserRef.key;
            
            // Save User Data
            await set(newUserRef, {
                name: name,
                joinTime: serverTimestamp(),
                lastSeen: serverTimestamp(),
                online: true
            });

            localStorage.setItem('chatUserId', userId);
            localStorage.setItem('chatUserName', name);
            
            loginModal.style.display = 'none';
            getUserDataAndLogin(userId);
        };

        function getUserDataAndLogin(uid) {
            currentUser = { id: uid, name: localStorage.getItem('chatUserName') };
            chatContainer.style.display = 'flex';
            
            // Setup Listeners
            setupStatusListeners();
            loadMessages();
            setupTypingListener();
            
            // Handle Disconnect
            const userStatusRef = ref(db, `users/${uid}`);
            onDisconnect(userStatusRef).update({
                online: false,
                lastSeen: serverTimestamp()
            });
        }

        function setUserOnline(status) {
            update(ref(db, `users/${userId}`), {
                online: status,
                lastSeen: status ? serverTimestamp() : serverTimestamp()
            });
        }

        // --- Chat Features ---
        
        // 1. Send Text
        window.sendMessage = (type) => {
            let content = msgInput.value.trim();
            if (type === 'text' && !content) return;

            const messageData = {
                sender: 'user',
                type: type,
                content: content,
                timestamp: serverTimestamp(),
                status: 'sent' // sent, seen
            };

            push(ref(db, `messages/${userId}`), messageData);
            msgInput.value = '';
            
            // Stop typing indicator
            set(ref(db, `typing/${userId}`), false);
        };

        // 2. Image Handling
        window.handleImageSelect = (event) => {
            const file = event.target.files[0];
            if (file) {
                // Limit size (approx 2MB for Base64)
                if(file.size > 2000000) {
                    alert("Image too large! Select smaller image.");
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    selectedImageBase64 = e.target.result;
                    document.getElementById('preview-img').src = selectedImageBase64;
                    document.getElementById('image-preview-modal').style.display = 'flex';
                };
                reader.readAsDataURL(file);
            }
        };

        window.sendImage = () => {
            if(selectedImageBase64) {
                push(ref(db, `messages/${userId}`), {
                    sender: 'user',
                    type: 'image',
                    content: selectedImageBase64,
                    timestamp: serverTimestamp(),
                    status: 'sent'
                });
            }
            closePreview();
        };

        window.closePreview = () => {
            document.getElementById('image-preview-modal').style.display = 'none';
            document.getElementById('file-input').value = '';
            selectedImageBase64 = null;
        };

        // 3. Voice Recording
        window.startRecording = async () => {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("Audio recording not supported in this browser.");
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => {
                        const base64Audio = reader.result;
                        push(ref(db, `messages/${userId}`), {
                            sender: 'user',
                            type: 'audio',
                            content: base64Audio,
                            timestamp: serverTimestamp(),
                            status: 'sent'
                        });
                    };
                };

                mediaRecorder.start();
                document.getElementById('recording-indicator').style.display = 'inline';
                isRecording = true;
            } catch (err) {
                console.error("Mic Error:", err);
            }
        };

        window.stopRecording = () => {
            if (isRecording && mediaRecorder) {
                mediaRecorder.stop();
                document.getElementById('recording-indicator').style.display = 'none';
                isRecording = false;
            }
        };

        // 4. Receive Messages & History
        function loadMessages() {
            const msgsRef = ref(db, `messages/${userId}`);
            onValue(msgsRef, (snapshot) => {
                msgsArea.innerHTML = '';
                const data = snapshot.val();
                if (!data) return;

                Object.values(data).forEach(msg => {
                    renderMessage(msg);
                });
                scrollToBottom();
            });
        }

        function renderMessage(msg) {
            const div = document.createElement('div');
            const isMe = msg.sender === 'user';
            
            div.className = `message ${isMe ? 'msg-right' : 'msg-left'}`;
            
            // Checkmark Logic
            let checks = msg.status === 'seen' ? 'âœ”âœ”' : 'âœ”';
            if(!isMe) checks = ''; // Admin messages don't need checks for user

            let contentHtml = '';
            if(msg.type === 'image') {
                contentHtml = `<img src="${msg.content}" class="msg-img" onclick="window.open(this.src)">`;
            } else if (msg.type === 'audio') {
                contentHtml = `<audio controls class="msg-audio" src="${msg.content}"></audio>`;
            } else {
                contentHtml = `<span>${msg.content}</span>`;
            }

            div.innerHTML = `
                ${contentHtml}
                <div class="msg-meta">
                    <span>${formatTime(msg.timestamp)}</span>
                    <span>${checks}</span>
                </div>
            `;
            msgsArea.appendChild(div);
        }

        // 5. Typing & Status Listeners
        window.handleTyping = () => {
            set(ref(db, `typing/${userId}`), true);
            // Debounce reset
            setTimeout(() => set(ref(db, `typing/${userId}`), false), 2000);
        };

        function setupTypingListener() {
            onValue(ref(db, `adminTyping/${userId}`), (snap) => {
                if (snap.val()) {
                    typingIndicator.style.display = 'block';
                } else {
                    typingIndicator.style.display = 'none';
                }
            });
        }

        function setupStatusListeners() {
            // Listen for Admin Online Status (Simulated by checking if Admin is connected)
            // Since Admin isn't a "user" in the user list, we assume admin is always available or check specific node.
            // For this demo, let's assume Admin is 'online' if they have sent a message recently or simple manual toggle
            // Alternatively, we can check presence on a specific admin node.
            
            const adminStatusRef = ref(db, 'adminStatus');
            onValue(adminStatusRef, (snap) => {
                const status = snap.val();
                if(status && status.online) {
                    statusDot.classList.add('online');
                    adminStatusText.innerText = "Admin Online";
                } else {
                    statusDot.classList.remove('online');
                    adminStatusText.innerText = "Admin Offline"; // Or "Last seen today..."
                }
            });

            // Listen for Message Status Updates (Seen)
            const msgsRef = ref(db, `messages/${userId}`);
            onValue(msgsRef, (snap) => {
                // This triggers re-render, we update checks there
            });
        }

        // Helpers
        function scrollToBottom() {
            msgsArea.scrollTop = msgsArea.scrollHeight;
        }

        function formatTime(ts) {
            if(!ts) return '';
            const date = new Date(ts);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

    </script>
</body>
</html>
