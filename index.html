<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MAHTAB SAFE CHAT</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
html,body{
  margin:0;
  padding:0;
  height:100%;
  overflow:hidden;
  font-family:Poppins, sans-serif;
  background:#0b0a1a;
  color:#fff;
}

.app{
  display:flex;
  flex-direction:column;
  height:calc(var(--vh, 1vh) * 100);
}

.header{
  padding:14px;
  text-align:center;
  font-weight:700;
  font-size:24px;
  background: linear-gradient(90deg, #ff2f6d, #ff8a00, #1e90ff, #00d4ff);
  background-size:300% 300%;
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  animation:gradientMove 4s ease infinite;
}

@keyframes gradientMove{
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}

.msgs{
  flex:1;
  padding:14px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  -webkit-overflow-scrolling:touch;
}

.msg{
  padding:10px 12px;
  border-radius:14px;
  margin-bottom:8px;
  max-width:70%;
  word-wrap:break-word;
  animation:fadeUp 0.3s ease;
}

.msg.admin{
  background:linear-gradient(135deg,#ff2f6d,#ff8a00);
}

.msg.user{
  background:linear-gradient(135deg,#1e90ff,#00d4ff);
  margin-left:auto;
}

@keyframes fadeUp{
  from{opacity:0;transform:translateY(15px);}
  to{opacity:1;transform:translateY(0);}
}

.input{
  display:flex;
  padding:10px;
  align-items:center;
  background:#0b0a1a;
}

.input-border{
  flex:1;
  padding:2px;
  border-radius:30px;
  background:linear-gradient(270deg,#ff2f6d,#1e90ff,#00d4ff,#ff8a00);
  background-size:600% 600%;
  animation:borderMove 4s ease infinite;
}

.input-border input{
  width:100%;
  padding:12px 14px;
  border:none;
  outline:none;
  border-radius:26px;
  background:#0b0a1a;
  color:#fff;
  font-size:14px;
}

button{
  margin-left:10px;
  width:42px;
  height:42px;
  border:none;
  border-radius:50%;
  background:#ff2f6d;
  color:#fff;
  font-size:18px;
  cursor:pointer;
}
button:active{transform:scale(0.9);}

@keyframes borderMove{
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}

/* ðŸ”¥ EMOJI SEND ANIMATION */
.emoji-fly{
  position:fixed;
  bottom:90px;
  left:50%;
  transform:translateX(-50%);
  font-size:34px;
  pointer-events:none;
  z-index:9999;
  animation:emojiFly 0.7s ease forwards;
}

@keyframes emojiFly{
  0%{
    transform:translate(-50%,0) scale(0.5);
    opacity:0;
  }
  30%{opacity:1;}
  100%{
    transform:translate(-50%,-140px) scale(1.4);
    opacity:0;
  }
}
</style>
</head>

<body>
<div class="app">
  <div class="header">MAHTAB SAFE CHAT</div>
  <div class="msgs" id="msgs"></div>

  <div class="input">
    <div class="input-border">
      <input id="text" placeholder="Type message..." />
    </div>
    <button onclick="sendMsg()">âž¤</button>
  </div>
</div>

<script type="module">
/* MOBILE HEIGHT FIX */
function setVH(){
  document.documentElement.style.setProperty(
    '--vh',
    window.innerHeight * 0.01 + 'px'
  );
}
setVH();
window.addEventListener('resize', setVH);

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onValue, update, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyAqfguS1ucAtklcl06eB1JIWQr46XMpe7g",
  authDomain: "safe-chat-c0b9c.firebaseapp.com",
  databaseURL: "https://safe-chat-c0b9c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "safe-chat-c0b9c",
  storageBucket: "safe-chat-c0b9c.firebasestorage.app",
  messagingSenderId: "119640275300",
  appId: "1:119640275300:web:20ae984f4af1ffe6a62271"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* USERNAME */
let userId = localStorage.getItem("username");
if(!userId){
  userId = prompt("Enter your username:")?.trim() || "guest_"+Date.now();
  localStorage.setItem("username", userId);
}

/* SOUNDS */
const sendSound=new Audio("https://www.soundjay.com/buttons/sounds/button-3.mp3");
const receiveSound=new Audio("https://www.soundjay.com/buttons/sounds/button-09.mp3");
sendSound.load(); receiveSound.load();

document.body.addEventListener("click",()=>{
  sendSound.play().then(()=>sendSound.pause()).catch(()=>{});
  receiveSound.play().then(()=>receiveSound.pause()).catch(()=>{});
},{once:true});

let msgsBox;

/* EMOJI ANIMATION FUNCTION */
function emojiAnimation(emoji){
  const e=document.createElement("div");
  e.className="emoji-fly";
  e.textContent=emoji;
  document.body.appendChild(e);
  setTimeout(()=>e.remove(),700);
}

function updateLastActive(){
  update(ref(db,"chats/"+userId),{lastActive:Date.now()});
}

function loadMessages(){
  onValue(ref(db,"chats/"+userId),snap=>{
    msgsBox.innerHTML="";
    snap.forEach(m=>{
      const v=m.val();
      if(!v?.text) return;

      const d=document.createElement("div");
      d.className="msg "+(v.from==="admin"?"admin":"user");
      d.textContent=v.text;

      // âœ… Time + Tick in same line for user messages
      if(v.from==="user"){
        const timeTickWrapper=document.createElement("div");
        timeTickWrapper.style.fontSize="10px";
        timeTickWrapper.style.color="#ccc";
        timeTickWrapper.style.marginTop="4px";
        timeTickWrapper.style.display="flex";
        timeTickWrapper.style.justifyContent="flex-end";
        timeTickWrapper.style.alignItems="center";

        // Time
        if(v.time){
          const timeSpan=document.createElement("span");
          const date=new Date(v.time);
          let hours=date.getHours();
          const minutes=date.getMinutes().toString().padStart(2,"0");
          const ampm=hours>=12?"PM":"AM";
          hours=hours%12 || 12;
          timeSpan.textContent=`${hours}:${minutes} ${ampm}`;
          timeTickWrapper.appendChild(timeSpan);
        }

        // Tick
        const tickSpan=document.createElement("span");
        tickSpan.style.fontSize="12px";
        tickSpan.style.color="#ccc";
        tickSpan.style.marginLeft="6px";
        if(v.status==="sent") tickSpan.textContent="âœ”";
        if(v.status==="seen") tickSpan.textContent="âœ”âœ”";
        timeTickWrapper.appendChild(tickSpan);

        d.appendChild(timeTickWrapper);
      }

      // Admin message sound
      if(v.from==="admin") receiveSound.play().catch(()=>{});

      msgsBox.appendChild(d);
    });
    msgsBox.scrollTop=msgsBox.scrollHeight;
  });
}

window.sendMsg=async()=>{
  const input=document.getElementById("text");
  if(!input.value.trim()) return;

  const snap=await get(ref(db,"chats/"+userId+"/blocked"));
  if(snap.exists() && snap.val()===true){
    alert("You are blocked âŒ");
    return;
  }

  const msg=input.value;

  const em=msg.match(/\p{Extended_Pictographic}/u);
  if(em) emojiAnimation(em[0]);

  // âœ… Send message with status: sent
  push(ref(db,"chats/"+userId),{
    from:"user",
    text:msg,
    time:Date.now(),
    status:"sent"
  });

  sendSound.play().catch(()=>{});
  input.value="";
  updateLastActive();
};

window.onload=()=>{
  msgsBox=document.getElementById("msgs");
  updateLastActive();
  setInterval(updateLastActive,30000);
  loadMessages();
};
</script>
</body>
</html>
