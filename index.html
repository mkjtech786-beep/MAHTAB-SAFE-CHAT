<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Safe Chat - Mahtab Khan Jamali</title>
    <style>
        /* --- MODERN THEME VARIABLES --- */
        :root {
            --primary: #6C63FF;
            --secondary: #00D2D3;
            --bg-gradient: linear-gradient(135deg, #1a1a2e, #16213e);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
            --msg-out-bg: linear-gradient(135deg, var(--primary), #8e44ad);
            --msg-in-bg: #2f3640;
            --text-main: #ffffff;
            --text-sub: #bdc3c7;
            --danger: #ff4757;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg-gradient); 
            color: var(--text-main); 
            height: 100vh; 
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            width: 100%;
        }

        /* --- LOGIN SCREEN --- */
        #login-screen { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            padding: 30px; 
            position: relative; 
            z-index: 10; 
            width: 100%; 
            overflow-y: auto; 
        }
        .bg-circle { position: absolute; width: 300px; height: 300px; background: var(--primary); filter: blur(100px); opacity: 0.3; border-radius: 50%; z-index: -1; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        .login-card {
            background: var(--glass-bg); backdrop-filter: blur(15px); border: 1px solid var(--glass-border);
            padding: 40px 30px; border-radius: 30px; width: 100%; max-width: 350px; text-align: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }

        .app-logo { width: 80px; height: 80px; background: var(--msg-out-bg); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 0 20px rgba(108, 99, 255, 0.5); }
        h2 { margin-bottom: 25px; font-weight: 600; letter-spacing: 1px; }
        input { width: 100%; padding: 15px 20px; margin-bottom: 20px; border-radius: 15px; border: 1px solid transparent; background: rgba(0,0,0,0.3); color: #fff; outline: none; font-size: 1rem; transition: 0.3s; }
        input:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); }
        .btn-main { width: 100%; padding: 15px; border-radius: 15px; background: var(--msg-out-bg); color: white; font-weight: bold; border: none; font-size: 1rem; cursor: pointer; box-shadow: 0 5px 15px rgba(108, 99, 255, 0.4); transition: transform 0.2s; }
        .btn-main:active { transform: scale(0.95); }

        /* --- CHAT SCREEN LAYOUT --- */
        #chat-screen { 
            display: none; 
            width: 100%; 
            height: 100%; 
            flex-direction: column; 
            overflow: hidden; 
        }

        header { 
            flex-shrink: 0; 
            padding: 15px 20px; 
            background: rgba(26, 26, 46, 0.95); 
            border-bottom: 1px solid var(--glass-border); 
            display: flex; 
            align-items: center; 
            z-index: 5; 
        }

        .header-left { display: flex; align-items: center; gap: 12px; width: 100%; } 
        
        .avatar { 
            width: 45px; height: 45px; 
            background: linear-gradient(135deg, var(--primary), #8e44ad); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem; color: white;
            border: 2px solid rgba(255,255,255,0.2);
            flex-shrink: 0; 
        }

        .header-text h3 { font-size: 0.95rem; color: #fff; font-weight: 600; }
        .header-text span { font-size: 0.75rem; color: var(--text-sub); display: flex; align-items: center; gap: 4px; }
        .status-dot { width: 8px; height: 8px; background: #00b894; border-radius: 50%; }

        /* MESSAGES AREA */
        #messages { 
            flex: 1; 
            overflow-y: auto; 
            min-height: 0; 
            padding: 20px 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            background-image: url('data:image/svg+xml,%3Csvg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="%239C92AC" fill-opacity="0.05" fill-rule="evenodd"%3E%3Ccircle cx="3" cy="3" r="3"/%3E%3Ccircle cx="13" cy="13" r="3"/%3E%3C/g%3E%3C/svg%3E');
            scrollbar-width: none;
        }
        #messages::-webkit-scrollbar { display: none; }

        .message { max-width: 80%; padding: 10px 15px; border-radius: 20px; font-size: 0.95rem; line-height: 1.4; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.1); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .msg-out { align-self: flex-end; background: var(--msg-out-bg); color: white; border-bottom-right-radius: 5px; }
        .msg-in { align-self: flex-start; background: var(--msg-in-bg); color: white; border-bottom-left-radius: 5px; }
        .msg-img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; cursor: pointer; }
        .meta { font-size: 0.7rem; text-align: right; margin-top: 4px; opacity: 0.7; display: flex; justify-content: flex-end; align-items: center; gap: 3px; }

        /* TYPING INDICATOR */
        .typing-area { height: 25px; padding: 0 20px; font-size: 0.8rem; color: var(--secondary); font-style: italic; opacity: 0; transition: opacity 0.3s; flex-shrink: 0; }
        .typing-area.active { opacity: 1; }

        /* --- RECORDING OVERLAY (FIXED) --- */
        #recording-overlay {
            position: absolute; bottom: 90px; left: 20px; right: 20px;
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 20px;
            display: none; /* FIXED: Default Hidden */
            align-items: center; justify-content: space-between;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid var(--danger);
            z-index: 100;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .rec-info { display: flex; align-items: center; gap: 10px; color: white; }
        .rec-dot { width: 12px; height: 12px; background: var(--danger); border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }
        
        .rec-timer { font-family: monospace; font-size: 1.1rem; font-weight: bold; letter-spacing: 1px; }

        /* Waveform Animation */
        .waveform { display: flex; gap: 3px; align-items: center; height: 20px; margin-left: 10px; }
        .bar { width: 3px; background: var(--danger); border-radius: 3px; animation: wave 1s infinite ease-in-out; }
        .bar:nth-child(1) { height: 10px; animation-delay: 0.1s; }
        .bar:nth-child(2) { height: 18px; animation-delay: 0.2s; }
        .bar:nth-child(3) { height: 12px; animation-delay: 0.3s; }
        .bar:nth-child(4) { height: 20px; animation-delay: 0.1s; }
        .bar:nth-child(5) { height: 8px; animation-delay: 0.4s; }
        @keyframes wave { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(0.5); } }

        .stop-rec-btn { 
            width: 40px; height: 40px; background: var(--danger); 
            border-radius: 50%; display: flex; align-items: center; 
            justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(255, 71, 87, 0.4);
        }
        .stop-icon { width: 14px; height: 14px; background: white; border-radius: 2px; }

        /* INPUT BAR */
        .input-wrapper { 
            flex-shrink: 0; 
            background: rgba(26, 26, 46, 0.95); 
            backdrop-filter: blur(10px); 
            padding: 10px 15px; 
            border-top: 1px solid var(--glass-border); 
            padding-bottom: max(10px, env(safe-area-inset-bottom)); 
        }

        .preview-box { display: flex; gap: 10px; margin-bottom: 10px; overflow-x: auto; }
        .preview-item { height: 80px; border-radius: 10px; border: 1px solid var(--primary); position: relative; flex-shrink: 0; }
        .preview-item img { height: 100%; border-radius: 10px; }
        .close-preview { position: absolute; top: -5px; right: -5px; background: #ff7675; width: 20px; height: 20px; border-radius: 50%; color: white; display: flex; justify-content: center; align-items: center; font-size: 12px; cursor: pointer; }

        .input-bar { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 30px; position: relative; }
        
        .icon-btn { background: none; border: none; color: var(--text-sub); font-size: 1.4rem; cursor: pointer; padding: 8px; transition: 0.2s; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .icon-btn:hover { color: var(--primary); }
        .icon-btn.send { background: var(--primary); color: white; border-radius: 50%; width: 40px; height: 40px; padding: 0; font-size: 1.1rem; }

        #msg-input { flex: 1; padding: 12px; margin: 0; background: transparent; border: none; font-size: 1rem; text-align: left; min-width: 0; }

        /* Old Timer hidden */
        .record-timer { display: none !important; }

    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
        <div class="bg-circle"></div>
        <div class="login-card fade">
            <div class="app-logo">ü´Öüèª</div>
            <h2>"ÿ®ÿ±ÿß€ÅŸê ⁄©ÿ±ŸÖ ÿßŸæŸÜÿß ÿßÿµŸÑ ŸÜÿßŸÖ ÿØÿ±ÿ¨ ⁄©ÿ±€å⁄∫ ÿ™ÿß⁄©€Å ŸÖ€Åÿ™ÿßÿ® ⁄©Ÿà ŸÖÿπŸÑŸàŸÖ €ÅŸà ÿ≥⁄©€í ⁄©€Å ⁄©ŸàŸÜ ÿ±ÿßÿ®ÿ∑€Å ⁄©ÿ± ÿ±€Åÿß €Å€í€î"</h2>
            <input type="text" id="username" placeholder="Enter Your Name" autocomplete="off">
            <button class="btn-main" onclick="loginUser()">Start Chatting</button>
        </div>
    </div>

    <!-- CHAT SCREEN -->
    <div id="chat-screen">
        <!-- RECORDING OVERLAY -->
        <div id="recording-overlay">
            <div class="rec-info">
                <div class="rec-dot"></div>
                <div class="waveform">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                </div>
                <span class="rec-timer" id="overlay-timer">00:00</span>
            </div>
            <div class="stop-rec-btn" id="stop-rec-btn">
                <div class="stop-icon"></div>
            </div>
        </div>

        <header>
            <div class="header-left">
                <div class="avatar">M</div>
                <div class="header-text">
                    <h3>MAHTAB KHAN JAMALI</h3>
                    <span id="admin-status"><span class="status-dot"></span> Connecting...</span>
                </div>
            </div>
        </header>

        <div id="messages"></div>
        <div class="typing-area" id="typing-indicator">Mahatb Khan Jamali is typing...</div>

        <div class="input-wrapper">
            <div class="preview-box" id="preview-box"></div>
            <div class="input-bar">
                <input type="file" id="file-input" hidden onchange="handleImage(this)">
                <button class="icon-btn" onclick="document.getElementById('file-input').click()">üìé</button>
                
                <input type="text" id="msg-input" placeholder="Message..." onkeypress="checkEnter(event)">
                
                <button class="icon-btn" onclick="toggleEmoji()">üòä</button>
                <!-- Voice Button -->
                <button class="icon-btn" id="voice-btn">üéôÔ∏è</button>
                <button class="icon-btn send" onclick="sendMessage()">‚û§</button>
            </div>
        </div>
    </div>

    <!-- FIREBASE & RECORDER LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqfguS1ucAtklcl06eB1JIWQr46XMpe7g",
            authDomain: "safe-chat-c0b9c.firebaseapp.com",
            databaseURL: "https://safe-chat-c0b9c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "safe-chat-c0b9c",
            storageBucket: "safe-chat-c0b9c.firebasedatabase.app",
            messagingSenderId: "119640275300",
            appId: "1:119640275300:web:20ae984f4af1ffe6a62271"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentUser = JSON.parse(localStorage.getItem('vip_user')) || null;
        let selectedImage = null;

        // --- VOICE RECORDER VARIABLES ---
        let mediaRecorder;
        let audioChunks = [];
        let recordTimerInterval;
        let recordingSeconds = 0;
        let isRecording = false;

        // --- INIT ---
        function init() {
            if (currentUser) {
                showChat();
                updateUserStatus('online');
                setupRecorderEvents();
            }
        }

        function setupRecorderEvents() {
            const voiceBtn = document.getElementById('voice-btn');
            const stopBtn = document.getElementById('stop-rec-btn');
            
            if(!voiceBtn) return;

            // Mouse Events
            voiceBtn.addEventListener('mousedown', startRec);
            // Touch Events
            voiceBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startRec(); });

            // Stop button events
            stopBtn.addEventListener('click', stopRec);
            
            // Global Stop Events
            window.addEventListener('mouseup', () => { if(isRecording) stopRec(); });
            window.addEventListener('touchend', () => { if(isRecording) stopRec(); });
        }

        window.loginUser = () => {
            const name = document.getElementById('username').value.trim();
            if (!name) return alert('Please enter your name');
            const id = 'user_' + Date.now();
            currentUser = { id, name, joinTime: Date.now(), lastSeen: Date.now() };
            localStorage.setItem('vip_user', JSON.stringify(currentUser));
            set(ref(db, 'users/' + id), currentUser);
            showChat();
            updateUserStatus('online');
            setupRecorderEvents();
        };

        function showChat() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
        }

        // --- VOICE RECORDER LOGIC (FIXED DISPLAY) ---
        async function startRec() {
            if (isRecording) return;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                let mimeType = 'audio/webm';
                if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                    mimeType = 'audio/webm;codecs=opus';
                } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4';
                }

                const options = { mimeType: mimeType };
                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: mimeType }); 
                    stream.getTracks().forEach(track => track.stop());

                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => {
                        const base64Audio = reader.result;
                        if(base64Audio.length > 10000000) {
                             alert("Voice message too long. Sending demo audio instead.");
                             sendMessage('voice', 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');
                        } else {
                             sendMessage('voice', base64Audio);
                        }
                    };
                };

                mediaRecorder.start(1000);
                isRecording = true;
                
                // Show Overlay using 'display: flex'
                const overlay = document.getElementById('recording-overlay');
                if(overlay) overlay.style.display = 'flex';
                
                recordingSeconds = 0;
                updateTimerDisplay();
                recordTimerInterval = setInterval(() => {
                    recordingSeconds++;
                    updateTimerDisplay();
                }, 1000);

            } catch (err) {
                console.error("Recording Error:", err);
                alert("Microphone Error: " + err.message + "\n\nNote: Voice recording requires HTTPS or Localhost.");
                isRecording = false;
            }
        }

        function updateTimerDisplay() {
            const mins = Math.floor(recordingSeconds / 60).toString().padStart(2, '0');
            const secs = (recordingSeconds % 60).toString().padStart(2, '0');
            const timerEl = document.getElementById('overlay-timer');
            if(timerEl) timerEl.innerText = `${mins}:${secs}`;
        }

        function stopRec() {
            if (!isRecording) return;
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            isRecording = false;
            clearInterval(recordTimerInterval);
            
            // Hide Overlay using 'display: none'
            const overlay = document.getElementById('recording-overlay');
            if(overlay) overlay.style.display = 'none';
        }

        // --- CHAT LOGIC ---
        window.sendMessage = (type = 'text', content = null) => {
            if (!currentUser) return;

            let msgContent = content;
            if (type === 'text') {
                const input = document.getElementById('msg-input');
                msgContent = input.value.trim();
                if (!msgContent && !selectedImage) return;
                input.value = '';
            }

            const msgData = {
                senderId: currentUser.id,
                receiverId: 'admin',
                type: type,
                content: msgContent,
                timestamp: Date.now(),
                status: 'sent'
            };

            push(ref(db, 'messages'), msgData);
            removeImagePreview();
        };

        window.checkEnter = (e) => {
            if (e.key === 'Enter') {
                if (selectedImage) sendMessage('image', selectedImage);
                else sendMessage('text');
            } else {
                set(ref(db, 'typing/' + currentUser.id), true);
                setTimeout(() => set(ref(db, 'typing/' + currentUser.id), false), 2000);
            }
        };

        function listenMessages() {
            const msgsRef = ref(db, 'messages');
            onValue(msgsRef, (snapshot) => {
                const data = snapshot.val();
                const chatBox = document.getElementById('messages');
                chatBox.innerHTML = '';

                if (data) {
                    Object.values(data)
                        .filter(m => 
                            (m.senderId === currentUser.id && m.receiverId === 'admin') ||
                            (m.senderId === 'admin' && m.receiverId === currentUser.id)
                        )
                        .sort((a, b) => a.timestamp - b.timestamp)
                        .forEach(msg => renderMessage(msg));
                }
                scrollToBottom();
            });
        }

        function renderMessage(msg) {
            const isMe = msg.senderId === currentUser.id;
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'msg-out' : 'msg-in'}`;
            
            let html = '';
            if(msg.type === 'text') html += msg.content;
            if(msg.type === 'image') html += `<img src="${msg.content}" class="msg-img" onclick="window.open(this.src)">`;
            
            if(msg.type === 'voice') {
                html += `
                <div style="display:flex; align-items:center; gap:8px; min-width: 120px;">
                    <div style="width:30px; height:30px; background:${isMe?'rgba(255,255,255,0.2)':'rgba(255,255,255,0.1)'}; border-radius:50%; display:flex; align-items:center; justify-content:center;">üéôÔ∏è</div>
                    <audio src="${msg.content}" controls style="height:30px; flex:1;"></audio>
                </div>`;
            }

            const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            html += `<div class="meta">${isMe ? (msg.status === 'seen' ? '‚úì‚úì' : '‚úì') : ''} ${time}</div>`;
            
            div.innerHTML = html;
            document.getElementById('messages').appendChild(div);
        }

        // --- LISTENERS & STATUS LOGIC ---
        function listenAdminStatus() {
            const adminRef = ref(db, 'admin_status');
            onValue(adminRef, (snap) => {
                const val = snap.val();
                const statusEl = document.getElementById('admin-status');
                
                if(val && (Date.now() - val.lastSeen) < 5000) {
                    statusEl.innerHTML = '<span class="status-dot"></span> Online';
                    statusEl.style.color = '#00b894';
                } else if (val) {
                    const date = new Date(val.lastSeen);
                    const timeStr = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true });
                    statusEl.innerHTML = `Last seen ${timeStr}`;
                    statusEl.style.color = '#636e72';
                } else {
                    statusEl.innerHTML = 'Offline';
                    statusEl.style.color = '#636e72';
                }
            });
        }

        function listenTyping() {
            onValue(ref(db, 'typing/admin'), (snap) => {
                const el = document.getElementById('typing-indicator');
                if(snap.val()) el.classList.add('active');
                else el.classList.remove('active');
            });
        }

        // --- EXTRAS ---
        window.handleImage = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImage = e.target.result;
                    const box = document.getElementById('preview-box');
                    box.innerHTML = `
                        <div class="preview-item">
                            <img src="${selectedImage}">
                            <div class="close-preview" onclick="removeImagePreview()">√ó</div>
                        </div>`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        function removeImagePreview() {
            selectedImage = null;
            document.getElementById('preview-box').innerHTML = '';
            document.getElementById('file-input').value = '';
        }

        window.toggleEmoji = () => {
            const emojis = ['üòÄ','‚ù§Ô∏è','üî•','üëç','üòé'];
            const input = document.getElementById('msg-input');
            input.value += emojis[Math.floor(Math.random()*emojis.length)];
        };

        function updateUserStatus(status) {
            if(!currentUser) return;
            update(ref(db, 'users/' + currentUser.id), {
                lastSeen: Date.now(),
                online: status === 'online'
            });
        }

        function scrollToBottom() {
            const div = document.getElementById('messages');
            div.scrollTop = div.scrollHeight;
        }

        // Keep alive
        setInterval(() => updateUserStatus('online'), 3000);

        // Start
        init();
        listenMessages();
        listenAdminStatus();
        listenTyping();

    </script>
</body>
</html>
